name: Continuous Deployment

env:
  WEB_RAILWAY_SERVICE_ID: 588272af-55fa-4a08-b0a2-ec2dec7600ce
  API_RAILWAY_SERVICE_ID: 838138b2-64c1-4ec4-8574-d272debeb5df
  CRON_RAILWAY_SERVICE_ID: 348ba788-3282-4f27-9967-ca04eea9ac4b
  OG_RAILWAY_SERVICE_ID: 76d31e4b-218d-4f82-974d-f2c8e91480e2

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      api-changed: ${{ steps.filter.outputs.api }}
      cron-changed: ${{ steps.filter.outputs.cron }}
      og-changed: ${{ steps.filter.outputs.og }}
    steps:
      - name: Checkout 🚪
        uses: actions/checkout@v4

      - name: Check for changes 🔍
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            web:
              - 'apps/web/**'
              - 'packages/**'
            api:
              - 'apps/api/**'
              - 'packages/**'
            cron:
              - 'apps/cron/**'
              - 'packages/**'
            og:
              - 'apps/og/**'
              - 'packages/**'

  web:
    needs: check-changes
    if: needs.check-changes.outputs.web-changed == 'true'
    name: heyxyz/web:latest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🚪
        uses: actions/checkout@v4

      - name: Build and push heyxyz/web:latest 🚀
        uses: ./.github/actions/docker
        with:
          dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
          image_name: web
          tag_name: "v3"
          docker_file: ./apps/web/Dockerfile
          build_args: |
            NEXT_PUBLIC_IS_PRODUCTION=true
            NEXT_PUBLIC_LENS_NETWORK=testnet

      - name: Trigger Web Deployment 🚀
        uses: indiesdev/curl@v1
        id: deploy
        with:
          url: "https://redeploy.heyxyz.workers.dev"
          params: '{ "secret": "${{ secrets.SECRET }}", "service": "${{ env.WEB_RAILWAY_SERVICE_ID }}" }'
          method: "GET"
          timeout: 30000

  api:
    needs: check-changes
    if: needs.check-changes.outputs.api-changed == 'true'
    name: heyxyz/api:latest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🚪
        uses: actions/checkout@v4

      - name: Build and push heyxyz/api:latest 🚀
        uses: ./.github/actions/docker
        with:
          dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
          image_name: api
          tag_name: "v3"
          docker_file: ./apps/api/Dockerfile

      - name: Trigger API Deployment 🚀
        uses: indiesdev/curl@v1
        id: deploy
        with:
          url: "https://redeploy.heyxyz.workers.dev"
          params: '{ "secret": "${{ secrets.SECRET }}", "service": "${{ env.API_RAILWAY_SERVICE_ID }}" }'
          method: "GET"
          timeout: 30000

  cron:
    needs: check-changes
    if: needs.check-changes.outputs.cron-changed == 'true'
    name: heyxyz/cron:latest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🚪
        uses: actions/checkout@v4

      - name: Build and push heyxyz/cron:latest 🚀
        uses: ./.github/actions/docker
        with:
          dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
          image_name: cron
          tag_name: "v3"
          docker_file: ./apps/cron/Dockerfile

      # - name: Trigger Cron Deployment 🚀
      #   uses: indiesdev/curl@v1
      #   id: deploy
      #   with:
      #     url: "https://redeploy.heyxyz.workers.dev"
      #     params: '{ "secret": "${{ secrets.SECRET }}", "service": "${{ env.CRON_RAILWAY_SERVICE_ID }}" }'
      #     method: "GET"
      #     timeout: 30000

  og:
    needs: check-changes
    if: needs.check-changes.outputs.og-changed == 'true'
    name: heyxyz/og:latest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🚪
        uses: actions/checkout@v4

      - name: Build and push heyxyz/og:latest 🚀
        uses: ./.github/actions/docker
        with:
          dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
          image_name: og
          tag_name: "v3"
          docker_file: ./apps/og/Dockerfile

      # - name: Trigger OG Deployment 🚀
      #   uses: indiesdev/curl@v1
      #   id: deploy
      #   with:
      #     url: "https://redeploy.heyxyz.workers.dev"
      #     params: '{ "secret": "${{ secrets.SECRET }}", "service": "${{ env.OG_RAILWAY_SERVICE_ID }}" }'
      #     method: "GET"
      #     timeout: 30000
